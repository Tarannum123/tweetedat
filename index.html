<!DOCTYPE html>
<html>
<head>
    <title>TweetedAt: Find the date and time of a tweet</title>
    <style>
        html {
            background-color: #dfe6e9;
            font-family: sans-serif;
        }
        body {
            margin: 0;
            padding-bottom: 30px;
        }
        section {
            max-width: 750px;
            margin: 10px auto;
            padding: 10px;
            border-radius: 20px;
        }
        #main {
            background-color: #74b9ff;
        }
        #info {
            background-color: #81ecec;
            color: #636e72;
        }
        #info a {
            color: #636e72;
        }
        h1 {
            text-align: center;
            margin: 10px;
        }
        input {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
        }
        pre {
            border: 1px solid #000;
            background-color: #2d3436;
            color: #dfe6e9;
            padding: 10px;
            border-radius: 10px;
            overflow: auto;
            font-size: 15px;
        }
        code a, code b {
            color: #fff;
        }
        footer {
            position: fixed;
            bottom: 0;
            background-color: #2d3436;
            color: #dfe6e9;
            text-align: center;
            font-size: 12px;
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        footer a {
            color: #dfe6e9;
        }
    </style>
</head>
<body>
    <section id="main">
            <h1>TweetedAt</h1>
            <input type="text" placeholder="Tweet ID or URL">
            <pre><code>Input a valid Tweet ID or URL</code></pre>
    </section>
    <section id="info">
        <p><a href="https://github.com/oduwsdl/tweetedat">TweetedAt</a> extracts date and time from the tweet ID by reverse-engineering <a href="https://blog.twitter.com/engineering/en_us/a/2010/announcing-snowflake.html">Twitter Snowflake</a>.</p>
        <p>Why not check on Twitter directly?</p>
        <ul>
            <li><a href="https://help.twitter.com/en/using-twitter/delete-tweets">Deleted tweets</a> do not have their metadata accessible from the API</li>
            <li>Twitter has <a href="https://developer.twitter.com/en/docs/basics/rate-limits">API access rate limits</a></li>
        </ul>
    </section>
    <footer><a href="https://github.com/oduwsdl/tweetedat">TweetedAt</a> by <a href="https://twitter.com/WebSciDL">Web Science and Digital Libraries Research Group</a>, <a href="https://odu.edu/compsci">Department of Computer Science</a>, <a href="https://odu.edu/">Old Dominion University</a>, Norfolk VA - 23529</footer>
    <script>
        let tweetMap = [
            [111, 1143052573],
            [552, 1143583337],
            [994, 1144011018],
            [1437, 1144383289],
            [1878, 1144808542],
            [2319, 1145228050],
            [2542, 1145566256],
            [2760, 1145836891],
            [3201, 1146435791],
            [3642, 1146880278],
            [4084, 1147375788],
            [4526, 1147817337],
            [4968, 1148318048],
            [5410, 1148783202],
            [5851, 1149269363],
            [6293, 1149807760],
            [6731, 1150355000],
            [7170, 1150830968],
            [7612, 1151182816],
            [8052, 1151535830],
            [8497, 1151871691],
            [8935, 1152235993],
            [9818, 1152837587],
            [10701, 1153088256],
            [12465, 1153444969],
            [14228, 1154023484],
            [28344, 1157925234],
            [30109, 1158209667],
            [31874, 1158555653],
            [33638, 1158889087],
            [35403, 1159292193],
            [37169, 1159606715],
            [38931, 1160021070],
            [40696, 1160427062],
            [42459, 1160686450],
            [44223, 1161049348],
            [45988, 1161388612],
            [49517, 1161911171],
            [53046, 1162312786],
            [56575, 1162694341],
            [60118, 1163028858],
            [63662, 1163312563],
            [70749, 1163750001],
            [84923, 1164172982],
            [113033, 1164225336],
            [225943, 1164474063],
            [451113, 1164838253],
            [676613, 1165337754],
            [902103, 1165727650],
            [1127663, 1166119383],
            [1352993, 1166508307],
            [1578763, 1166847492],
            [1803863, 1167363971],
            [2029283, 1167780578],
            [2254693, 1168079766],
            [2705523, 1168608167],
            [3156353, 1169059986],
            [3607173, 1169412420],
            [4058063, 1169735254],
            [4508943, 1170061507],
            [4959823, 1170326617],
            [5185273, 1170460703],
            [5298213, 1170564164],
            [5410703, 1171117122],
            [5523424, 1171559529],
            [5636145, 1172123550],
            [5748868, 1172662193],
            [5861587, 1173133348],
            [6312471, 1173530474],
            [7214231, 1173747374],
            [9017761, 1174160988],
            [10821291, 1174530859],
            [14428351, 1175104746],
            [18035411, 1175555771],
            [21642471, 1175978356],
            [25249641, 1176342449],
            [28856581, 1176644585],
            [32463651, 1176934236],
            [36070702, 1177259518],
            [43284812, 1177783864],
            [50499262, 1178336402],
            [57713042, 1178743224],
            [64927282, 1179235916],
            [72141502, 1179731833],
            [79355732, 1180192852],
            [86569512, 1180691507],
            [93783632, 1181161232],
            [100997742, 1181630775],
            [108211862, 1182072379],
            [115425972, 1182475685],
            [122640132, 1182930706],
            [129854292, 1183336921],
            [137068452, 1183722130],
            [144282382, 1184137075],
            [151496712, 1184538790],
            [158710812, 1184903309],
            [165924912, 1185287600],
            [173138792, 1185635048],
            [180352902, 1185975319],
            [187567002, 1186298235],
            [194781112, 1186608695],
            [201995212, 1186942124],
            [209209322, 1187273457],
            [216423412, 1187634316],
            [223637512, 1187918210],
            [230851612, 1188244210],
            [238065752, 1188518021],
            [245279892, 1188865455],
            [259708162, 1189459371],
            [274136442, 1190029719],
            [288564712, 1190583392],
            [302992882, 1191161686],
            [317421042, 1191725116],
            [331849202, 1192230320],
            [346277362, 1192749531],
            [360705862, 1193249306],
            [375133912, 1193753039],
            [389562072, 1194264077],
            [403990232, 1194718194],
            [418418512, 1195188251],
            [432846782, 1195671545],
            [447274942, 1196145386],
            [461703102, 1196562247],
            [476131312, 1196974867],
            [490559512, 1197391105],
            [504987932, 1197775162],
            [519415902, 1198195671],
            [533844212, 1198643965],
            [548272522, 1199075186],
            [562700612, 1199469653],
            [577128692, 1199827766],
            [591556892, 1200156715],
            [605985092, 1200501696],
            [620413292, 1200839771],
            [634841482, 1201144450],
            [649269742, 1201493945],
            [663697992, 1201812865],
            [678126132, 1202171615],
            [692554272, 1202528879],
            [706982582, 1202899506],
            [721410672, 1203217047],
            [735838872, 1203529507],
            [750267062, 1203827229],
            [764695259, 1204243571],
            [766498787, 1204632349],
            [768302311, 1204938682],
            [770105835, 1205280827],
            [771909359, 1205580585],
            [773712883, 1205900388],
            [775516408, 1206215303],
            [779123457, 1206792700],
            [782730507, 1207306498],
            [786337556, 1207818241],
            [789944605, 1208307583],
            [793551655, 1208781989],
            [797158706, 1209171096],
            [800765755, 1209597238],
            [804372804, 1210043244],
            [807979853, 1210425780],
            [811586904, 1210819853],
            [815193954, 1211225390],
            [818801003, 1211605994],
            [822408052, 1212058180],
            [826015101, 1212502836],
            [829622150, 1212910498],
            [833229201, 1213294767],
            [836836248, 1213708824],
            [840443302, 1214074655],
            [844050347, 1214478785],
            [847657397, 1214920919],
            [851264447, 1215350863],
            [854871495, 1215712842],
            [858478544, 1216077656],
            [862085594, 1216404534],
            [865692642, 1216776456],
            [869299691, 1217110904],
            [872906740, 1217446882],
            [876513792, 1217785045],
            [880120839, 1218090046],
            [883727888, 1218421160],
            [887334937, 1218718142],
            [890941986, 1219057517],
            [894549036, 1219335715],
            [901763137, 1219936806],
            [908977234, 1220499619],
            [916191332, 1221038970],
            [923405431, 1221576242],
            [930619536, 1222103113],
            [937833641, 1222579137],
            [945047747, 1223048013],
            [952261851, 1223524282],
            [959475955, 1224010100],
            [966690059, 1224456089],
            [973904164, 1224868825],
            [981118268, 1225312971],
            [988332372, 1225750899],
            [995546476, 1226093512],
            [1002760579, 1226525653],
            [1009974682, 1226946194],
            [1017188787, 1227301998],
            [1024402891, 1227701409],
            [1031616993, 1228100655],
            [1038831096, 1228422839],
            [1046045202, 1228780616],
            [1053259305, 1229084939],
            [1060473410, 1229429616],
            [1067687514, 1229714836],
            [1074901619, 1230061747],
            [1082115725, 1230458248],
            [1089329828, 1230780877],
            [1096543930, 1231133750],
            [1110972138, 1231683849],
            [1125400347, 1232161629],
            [1139828557, 1232650350],
            [1154256761, 1233114792],
            [1168684970, 1233543690],
            [1183113179, 1233927350],
            [1197541387, 1234314335],
            [1211969596, 1234690091],
            [1226397803, 1235045833],
            [1240826011, 1235397373],
            [1255254219, 1235681539],
            [1269682426, 1236009413],
            [1298538842, 1236563357],
            [1327395258, 1237046327],
            [1356251677, 1237491907],
            [1385108091, 1237941615],
            [1413964507, 1238360514],
            [1442820924, 1238726655],
            [1471677340, 1239134328],
            [1500533757, 1239501292],
            [1529390175, 1239838421],
            [1558246590, 1240152364],
            [1615959423, 1240696987],
            [1673672257, 1241217630],
            [1731385087, 1241733169],
            [1789097919, 1242255465],
            [1846810751, 1242737761],
            [1904523583, 1243188926],
            [1962236415, 1243619047],
            [2019949248, 1244056588],
            [2077662080, 1244477657],
            [2135374918, 1244834253],
            [2193087754, 1245164331],
            [2250800582, 1245486693],
            [2308513410, 1245837571],
            [2366226243, 1246152955],
            [2423939077, 1246472704],
            [2481651912, 1246796300],
            [2539364744, 1247089079],
            [2654790408, 1247680266],
            [2770216070, 1248229576],
            [3231918730, 1249937107],
            [3347344395, 1250445848],
            [3462770061, 1250903264],
            [3578195727, 1251376423],
            [3693621390, 1251829310],
            [3809047056, 1252285794],
            [3924472720, 1252718509],
            [4039898385, 1253139860],
            [4155324050, 1253566668],
            [4386175380, 1253936922],
            [4501601045, 1254329774],
            [4617026710, 1254705780],
            [4732452379, 1255088955],
            [4847878041, 1255476947],
            [4963303709, 1255855099],
            [5078729371, 1256243840],
            [5194155037, 1256621467],
            [5309580700, 1256974836],
            [5425006366, 1257354742],
            [5540432030, 1257713389],
            [5655857696, 1258050508],
            [5771283360, 1258394643],
            [5886709025, 1258717057],
            [6002134691, 1259047713],
            [6117560355, 1259343229],
            [6232986020, 1259668937],
            [6348411685, 1259958903],
            [6463837350, 1260280489],
            [6694688680, 1260880757],
            [6925540011, 1261478218],
            [7040965675, 1261772139],
            [7156391340, 1262084861],
            [7387242670, 1262655877],
            [7618094002, 1263183874],
            [7848945334, 1263695956],
            [8079796665, 1264185698],
            [8310647993, 1264655184],
            [8541499323, 1265116174],
            [8772350654, 1265565129],
            [9003201983, 1265970117],
            [9234053313, 1266414356],
            [9464904644, 1266819238],
            [9695755976, 1267217193],
            [9926607313, 1267627384],
            [10157458638, 1268025780],
            [10388309968, 1268425329],
            [10619161296, 1268829188],
            [10850012626, 1269223439],
            [11080863955, 1269594521],
            [11311715289, 1269960799],
            [11542566616, 1270312674],
            [12004269274, 1271011617],
            [12235120603, 1271352875],
            [12465971933, 1271696880],
            [12696823265, 1272022547],
            [12927674593, 1272344340],
            [13158525922, 1272672902],
            [13389377252, 1273013932],
            [13620228582, 1273340031],
            [13851079912, 1273670973],
            [14081931242, 1273989779],
            [14312782572, 1274298367],
            [14774485230, 1274891791],
            [15236187890, 1275464074],
            [15697890551, 1275994040],
            [16159593212, 1276532466],
            [16621295872, 1277044968],
            [17082998532, 1277547724],
            [17544701192, 1278043320],
            [18006403852, 1278561196],
            [18468106512, 1279057191],
            [18929809172, 1279558509],
            [19391511831, 1279941949],
            [19853214490, 1280435704],
            [20314917150, 1280937914],
            [20776619812, 1281425573],
            [21238322474, 1281885784],
            [21700025131, 1282343311],
            [22161727789, 1282811973],
            [22623430449, 1283266809],
            [23085133108, 1283717335],
            [24008538428, 1284038457],
            [24470241089, 1284466784],
            [24931943748, 1284900544],
            [25393646408, 1285326047],
            [25855349068, 1285736263],
            [26317051730, 1286152898],
            [26778754391, 1286566479],
            [27240457052, 1286976252],
            [27702159708, 1287373623],
            [28625565030, 1287951653],
            [29087267689, 1288358752],
            [29548970348, 1288768002]
        ];
        function snowflakeToTime(tweetId) {
          return new Date(parseInt(tweetId / 2 ** 22) + 1288834974657);
        }

        function estimateTweetTime(tweetId) {
          if (tweetId < tweetMap[0][0]){
            return -1
          }
          for (let i = 0; i < tweetMap.length; i++){
              if (tweetMap[i][0] == tweetId){
                  return new Date(parseInt(tweetMap[i][1] * 1000));
              }
              else if (tweetId < tweetMap[i][0]) {
                  return new Date(parseInt((tweetMap[i - 1][1] + (((tweetId - tweetMap[i - 1][0]) / (tweetMap[i][0] - tweetMap[i - 1][0])) * (tweetMap[i][1] - tweetMap[i - 1][1]))) * 1000));
              }
          }
        }

        function relativeTime(tweetTime) {
            let diff = Date.now() - tweetTime;
            if (diff < 0) {
                return 'From the future!';
            }
            const datetimeUnits = ['year', 'month', 'day', 'hour', 'minute', 'second', 'millisecond'];
            let datetimeParts = new Date(diff).toISOString().split(/\D/).map(x => parseInt(x));
            datetimeParts[0] -= 1970;
            datetimeParts[1] -= 1;
            datetimeParts[2] -= 1;
            let primaryUnit, secondaryUnit, primaryQuotient, secondaryQuotient;
            for (let i = 0; i < datetimeUnits.length - 1; i++) {
                if (datetimeParts[i] == 0) {
                    continue;
                }
                [primaryUnit, secondaryUnit] = datetimeUnits.slice(i, i + 2);
                [primaryQuotient, secondaryQuotient] = datetimeParts.slice(i, i + 2);
                break;
            }
            let diffStr = `${primaryQuotient} ${primaryUnit}${primaryQuotient != 1 ? 's' : ''}`;
            if (secondaryQuotient > 0) {
                diffStr += ` and ${secondaryQuotient} ${secondaryUnit}${secondaryQuotient != 1 ? 's' : ''}`;
            }
            return `${diffStr} ago`;
        }

        function showTweetTime() {
            let tid = document.querySelector('input').value.replace(/^(https?:\/\/)?twitter.com\/\w+\/status\//i, '').replace(/\D+.*$/, '');
            let result = 'Input a valid Tweet ID or URL';
            if (tid && !isNaN(tid) && !(tid.length > 20)) {
                // 356009025474562 is a tweet ID from http://web.archive.org/web/20101107012803/twitter.com/cnn around Snowflake deployment
                // TODO: We need to identify a more exact number when transition to Snowflake happened
                if (parseInt(tid) <= 29548970348) {
                    let ttime = estimateTweetTime(tid);
                    if (ttime > 0){
                        result = [`<i>* The tweet timestamp estimate may be off by &#177 3 days </i>`,
                                  `<b>Tweet ID:</b>         ${tid}`,
                                  `<b>Tweeted:</b>          ${relativeTime(ttime)}`,
                                  `<b><a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8061</a>:</b>         ${ttime.toISOString()}`,
                                  `<b><a href="https://tools.ietf.org/html/rfc1123">RFC 1123</a>:</b>         ${ttime.toUTCString()}`,
                                  `<b>In your timezone:</b> ${ttime.toString().replace(/(\S{3}) (\S{3}) (\d{2}) (.*)/, "$1, $3 $2 $4")}`].join(`\n`);
                    }
                } else {
                    let ttime = snowflakeToTime(tid);
                    result = [`<b>Tweet ID:</b>         ${tid}`,
                              `<b>Tweeted:</b>          ${relativeTime(ttime)}`,
                              `<b><a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8061</a>:</b>         ${ttime.toISOString()}`,
                              `<b><a href="https://tools.ietf.org/html/rfc1123">RFC 1123</a>:</b>         ${ttime.toUTCString()}`,
                              `<b>In your timezone:</b> ${ttime.toString().replace(/(\S{3}) (\S{3}) (\d{2}) (.*)/, "$1, $3 $2 $4")}`].join('\n');
                }
                location.hash = `#${tid}`;
            } else {
                history.pushState('', document.title, window.location.pathname);
            }
            document.querySelector('code').innerHTML = result;
        }
        document.querySelector('input').oninput = showTweetTime;

        function populateInput() {
            const input = document.querySelector('input');
            input.value = location.hash.replace('#', '');
            input.oninput();
        };
        window.onload = populateInput;
        window.onhashchange = populateInput;
    </script>
</body>
</html>
